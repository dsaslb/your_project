{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<h2>
    {% if DASHBOARD_MODE == 'solo' %}
        ğŸª 1ì¸ ì‚¬ì¥ë‹˜ ëŒ€ì‹œë³´ë“œ
    {% elif DASHBOARD_MODE == 'franchise' %}
        ğŸ¢ ê·¸ë£¹/í”„ëœì°¨ì´ì¦ˆ ìµœê³ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
    {% else %}
        ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì/íŒ€ì¥ ëŒ€ì‹œë³´ë“œ
    {% endif %}
</h2>

<!-- ëŒ€ì‹œë³´ë“œ ëª¨ë“œ í‘œì‹œ -->
<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i>
    <strong>í˜„ì¬ ëª¨ë“œ:</strong>
    {% if DASHBOARD_MODE == 'solo' %}
        <span class="badge bg-success">1ì¸ ì‚¬ì¥ë‹˜ ëª¨ë“œ</span> - ëª¨ë“  ì—…ë¬´ ë©”ë‰´ì— ì ‘ê·¼ ê°€ëŠ¥
    {% elif DASHBOARD_MODE == 'franchise' %}
        <span class="badge bg-primary">ê·¸ë£¹/í”„ëœì°¨ì´ì¦ˆ ëª¨ë“œ</span> - ìµœê³ ê´€ë¦¬ì ì „ìš© ë©”ë‰´ë§Œ í‘œì‹œ
    {% else %}
        <span class="badge bg-secondary">ì¼ë°˜ ê´€ë¦¬ì ëª¨ë“œ</span>
    {% endif %}
</div>

<!-- 1ì¸ ì‚¬ì¥ë‹˜ ëª¨ë“œ: ëª¨ë“  ê¸°ëŠ¥ í‘œì‹œ -->
{% if DASHBOARD_MODE == 'solo' %}
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-bg-light mb-3">
          <div class="card-body">
            <b>ì§ì› ìˆ˜:</b> {{total_staff}}<br>
            <b>ì˜¤ëŠ˜ ì¶œê·¼:</b> {{today_att}}ëª…
            <span style="color:red;">(ì§€ê°: {{late_cnt}} / ê²°ê·¼: {{abs_cnt}})</span><br>
            <b>ë¯¸ì²˜ë¦¬ ì‹ ê³ /ì´ì˜:</b> <span style="color:orange;">{{pending_reports}}</span><br>
            <b>ê²½ê³  ì§ì› ìˆ˜:</b> <span style="color:red;">{{warning_users}}</span>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <div class="card text-bg-light mb-3">
          <div class="card-body">
            <h5 class="card-title">ìµœê·¼ ì‚¬ìœ  TOP5</h5>
            <ul class="mb-0">
            {% for reason, cnt in top_reasons %}
              <li>{{ reason }} ({{ cnt }}íšŒ)</li>
            {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4 d-flex align-items-center">
        <div>
          <a href="{{ url_for('admin_excuse_list') }}" class="btn btn-warning mb-2">ì‹ ê³ /ì´ì˜ ì²˜ë¦¬ ë°”ë¡œê°€ê¸°</a>
          <a href="{{ url_for('attendance_stats') }}" class="btn btn-info mb-2">ì¶œê²° í†µê³„ ì°¨íŠ¸</a>
        </div>
      </div>
    </div>

    <!-- ê¸°ê°„ í•„í„° -->
    <form class="row g-3 mb-3">
      <div class="col-auto">
        <input type="date" class="form-control" name="from" value="{{ request.args.get('from','') }}">
      </div>
      <div class="col-auto">
        <input type="date" class="form-control" name="to" value="{{ request.args.get('to','') }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-secondary">ê¸°ê°„ê²€ìƒ‰</button>
      </div>
    </form>

    <!-- íŒ€/ì§ì›ë³„ í•„í„°ë§ í¼ -->
    <form method="get" class="row g-3 mb-3">
      <div class="col-md-2">
        <select name="team" class="form-select">
          <option value="">ì „ì²´íŒ€</option>
          {% for t in all_teams %}
          <option value="{{t}}" {% if request.args.get('team')==t %}selected{% endif %}>{{t}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select name="user_id" class="form-select">
          <option value="">ì „ì²´ì§ì›</option>
          {% for u in users %}
          <option value="{{u.id}}" {% if request.args.get('user_id')==u.id|string %}selected{% endif %}>{{u.name or u.username}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" name="from" class="form-control" value="{{request.args.get('from') or ''}}">
      </div>
      <div class="col-md-2">
        <input type="date" name="to" class="form-control" value="{{request.args.get('to') or ''}}">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary">í•„í„°</button>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">ì´ˆê¸°í™”</a>
      </div>
    </form>

    <!-- ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="btn-group" role="group">
          <a href="{{ url_for('export_admin_dashboard_excel', **request.args) }}" class="btn btn-success">
            <i class="fas fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
          </a>
          <a href="{{ url_for('export_admin_dashboard_pdf', **request.args) }}" class="btn btn-danger">
            <i class="fas fa-file-pdf"></i> PDF ë‹¤ìš´ë¡œë“œ
          </a>
        </div>
      </div>
    </div>

    <!-- ë¹ ë¥¸ ë§í¬ -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="btn-group" role="group">
          <a href="{{ url_for('admin_statistics') }}" class="btn btn-primary">
            <i class="fas fa-chart-bar"></i> ì›”ë³„ í†µê³„
          </a>
          <a href="{{ url_for('admin_attendance_reason_stats') }}" class="btn btn-warning">
            <i class="fas fa-chart-pie"></i> ì‚¬ìœ ë³„ í†µê³„
          </a>
          <a href="{{ url_for('admin_users') }}" class="btn btn-info">
            <i class="fas fa-users"></i> ì§ì› ê´€ë¦¬
          </a>
          <a href="{{ url_for('admin_swap_requests') }}" class="btn btn-warning">
            <i class="fas fa-exchange-alt"></i> ê·¼ë¬´ ë³€ê²½ ì‹ ì²­
          </a>
          <a href="{{ url_for('admin_reports') }}" class="btn btn-success">
            <i class="fas fa-file-alt"></i> ë³´ê³ ì„œ ê´€ë¦¬
          </a>
          <a href="{{ url_for('admin_all_notifications') }}" class="btn btn-info">
            <i class="fas fa-bell"></i> ì•Œë¦¼ì„¼í„°
          </a>
          <a href="{{ url_for('admin_all_notifications') }}" class="btn btn-primary">
            <i class="fas fa-bell"></i> ì „ì²´ ì•Œë¦¼ ê´€ë¦¬
          </a>
          <a href="{{ url_for('admin_notification_stats') }}" class="btn btn-success">
            <i class="fas fa-chart-pie"></i> ì•Œë¦¼ í†µê³„
          </a>
        </div>
      </div>
    </div>

<!-- ê·¸ë£¹/í”„ëœì°¨ì´ì¦ˆ ëª¨ë“œ: ìµœê³ ê´€ë¦¬ì ì „ìš© ë©”ë‰´ë§Œ í‘œì‹œ -->
{% elif DASHBOARD_MODE == 'franchise' %}
    <!-- ìµœê³ ê´€ë¦¬ì ì „ìš© í†µê³„ -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title">ì „ì²´ ë§¤ì¥ í˜„í™©</h5>
            <b>ì´ ë§¤ì¥ ìˆ˜:</b> {{ branch_list|length }}ê°œ<br>
            <b>ì´ ì§ì› ìˆ˜:</b> {{ num_users }}ëª…<br>
            <b>ìŠ¹ì¸ ëŒ€ê¸°:</b> <span style="color:yellow;">{{ pending_users|default(0) }}ëª…</span>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">ì‹œìŠ¤í…œ í˜„í™©</h5>
            <b>í‰ê·  ì²˜ë¦¬ì‹œê°„:</b> {{ avg_processing|default(0) }}ë¶„<br>
            <b>ê¸°ì¤€ ì´ˆê³¼:</b> <span style="color:red;">{{ exceed_count|default(0) }}ê±´</span><br>
            <b>ì‹œìŠ¤í…œ ìƒíƒœ:</b> <span style="color:green;">ì •ìƒ</span>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card text-bg-info mb-3">
          <div class="card-body">
            <h5 class="card-title">ìµœê·¼ í™œë™</h5>
            <b>ìµœê·¼ ì£¼ë¬¸:</b> {{ recent_orders|length }}ê±´<br>
            <b>ìµœê·¼ ì•Œë¦¼:</b> {{ recent_notifications|length }}ê±´<br>
            <b>ìµœê·¼ í”¼ë“œë°±:</b> {{ recent_feedbacks|length }}ê±´
          </div>
        </div>
      </div>
    </div>

    <!-- ìµœê³ ê´€ë¦¬ì ì „ìš© ë©”ë‰´ -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-crown"></i> ìµœê³ ê´€ë¦¬ì ì „ìš© ë©”ë‰´</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card border-primary">
                  <div class="card-body text-center">
                    <i class="fas fa-user-check fa-3x text-primary mb-3"></i>
                    <h5>ì§ì› ìŠ¹ì¸ ê´€ë¦¬</h5>
                    <p class="text-muted">ìƒˆë¡œìš´ ì§ì› ê°€ì… ìŠ¹ì¸ ë° ê¶Œí•œ ê´€ë¦¬</p>
                    <a href="{{ url_for('admin_approve_users') }}" class="btn btn-primary">
                      <i class="fas fa-users"></i> ì§ì› ìŠ¹ì¸
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card border-success">
                  <div class="card-body text-center">
                    <i class="fas fa-bell fa-3x text-success mb-3"></i>
                    <h5>ì•Œë¦¼ ë°œì†¡</h5>
                    <p class="text-muted">ì „ì²´ ì§ì› ëŒ€ìƒ ì•Œë¦¼ ë° ê³µì§€ì‚¬í•­ ë°œì†¡</p>
                    <a href="{{ url_for('admin_notify_send') }}" class="btn btn-success">
                      <i class="fas fa-paper-plane"></i> ì•Œë¦¼ ë°œì†¡
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card border-warning">
                  <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                    <h5>í†µí•© ë¦¬í¬íŠ¸</h5>
                    <p class="text-muted">ì „ì²´ ë§¤ì¥ í†µí•© í†µê³„ ë° ë¶„ì„ ë¦¬í¬íŠ¸</p>
                    <a href="{{ url_for('admin_reports') }}" class="btn btn-warning">
                      <i class="fas fa-file-alt"></i> ë¦¬í¬íŠ¸ ë³´ê¸°
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- ì¼ë°˜ ê´€ë¦¬ì ëª¨ë“œ -->
{% else %}
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-bg-light mb-3">
          <div class="card-body">
            <b>ì§ì› ìˆ˜:</b> {{total_staff}}<br>
            <b>ì˜¤ëŠ˜ ì¶œê·¼:</b> {{today_att}}ëª…
            <span style="color:red;">(ì§€ê°: {{late_cnt}} / ê²°ê·¼: {{abs_cnt}})</span><br>
            <b>ë¯¸ì²˜ë¦¬ ì‹ ê³ /ì´ì˜:</b> <span style="color:orange;">{{pending_reports}}</span><br>
            <b>ê²½ê³  ì§ì› ìˆ˜:</b> <span style="color:red;">{{warning_users}}</span>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <div class="card text-bg-light mb-3">
          <div class="card-body">
            <h5 class="card-title">ìµœê·¼ ì‚¬ìœ  TOP5</h5>
            <ul class="mb-0">
            {% for reason, cnt in top_reasons %}
              <li>{{ reason }} ({{ cnt }}íšŒ)</li>
            {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4 d-flex align-items-center">
        <div>
          <a href="{{ url_for('admin_excuse_list') }}" class="btn btn-warning mb-2">ì‹ ê³ /ì´ì˜ ì²˜ë¦¬ ë°”ë¡œê°€ê¸°</a>
          <a href="{{ url_for('attendance_stats') }}" class="btn btn-info mb-2">ì¶œê²° í†µê³„ ì°¨íŠ¸</a>
        </div>
      </div>
    </div>
{% endif %}

<!-- ë§¤ì¥ ê´€ë¦¬ìÂ·ì§ì› ì—…ë¬´ í˜ì´ì§€ ë°”ë¡œê°€ê¸° (1ì¸ ì‚¬ì¥ë‹˜ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
{% if DASHBOARD_MODE == 'solo' %}
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-store"></i> ë§¤ì¥ ê´€ë¦¬ìÂ·ì§ì› ì—…ë¬´ í˜ì´ì§€ ë°”ë¡œê°€ê¸°</h5>
          </div>
          <div class="card-body">
            {% if branch_list %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>ë§¤ì¥ëª…</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>ì§ì› ìˆ˜</th>
                    <th>ì—…ë¬´ ë°”ë¡œê°€ê¸°</th>
                  </tr>
                </thead>
                <tbody>
                  {% for branch in branch_list %}
                  <tr>
                    <td><strong>{{ branch.name }}</strong></td>
                    <td>{{ branch.manager_name }}</td>
                    <td>{{ branch.num_employees }}ëª…</td>
                    <td>
                      <div class="btn-group-vertical" role="group">
                        <!-- ë§¤ì¥ ê´€ë¦¬ì ì—…ë¬´ ëŒ€ì‹œë³´ë“œ ë°”ë¡œê°€ê¸° -->
                        <a href="{{ url_for('manager_dashboard', branch_id=branch.id) }}" 
                           class="btn btn-sm btn-primary mb-1">
                          <i class="fas fa-user-tie"></i> ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                        </a>
                        <!-- ì§ì› ì—…ë¬´ ë°”ë¡œê°€ê¸°(ì§ì›ë³„) -->
                        {% if branch.employees %}
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                    type="button" data-bs-toggle="dropdown">
                              <i class="fas fa-users"></i> ì§ì›ë³„ ì—…ë¬´
                            </button>
                            <ul class="dropdown-menu">
                              {% for emp in branch.employees %}
                              <li>
                                <a class="dropdown-item" 
                                   href="{{ url_for('employee_dashboard', employee_id=emp.id) }}">
                                  <i class="fas fa-user"></i> {{ emp.name or emp.username }} ì—…ë¬´
                                </a>
                              </li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% else %}
                          <span class="text-muted small">ë“±ë¡ëœ ì§ì› ì—†ìŒ</span>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> ë“±ë¡ëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤. 
              <a href="{{ url_for('admin_users') }}" class="alert-link">ë§¤ì¥ ë° ì§ì›ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
{% endif %}

<!-- ìƒˆë¡œìš´ ê´€ë¦¬ ê¸°ëŠ¥ ë©”ë‰´ -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-tools"></i> ì—…ë¬´ ê´€ë¦¬</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-primary w-100">
              <i class="fas fa-users"></i> ì§ì› ê´€ë¦¬
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-success w-100">
              <i class="fas fa-calendar-alt"></i> ìŠ¤ì¼€ì¤„ ê´€ë¦¬
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-warning w-100">
              <i class="fas fa-shopping-cart"></i> ë°œì£¼ ê´€ë¦¬
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-info w-100">
              <i class="fas fa-broom"></i> ì²­ì†Œ ê´€ë¦¬
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ìƒˆë¡œìš´ ê¸°ëŠ¥ ë²„íŠ¼ë“¤ -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cogs"></i> ìë™í™” ê¸°ëŠ¥</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-primary w-100">
              <i class="fas fa-file-pdf"></i> ì›”ë³„ ê·¼íƒœ ìš”ì•½ PDF
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-success w-100" 
               onclick="return confirm('ì¼ê´„ ê¸‰ì—¬ ì´ì²´ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
              <i class="fas fa-money-bill-wave"></i> ê¸‰ì—¬ ìë™ì´ì²´
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-info w-100">
              <i class="fas fa-bell"></i> ì•Œë¦¼ ë°œì†¡
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-secondary w-100">
              <i class="fas fa-download"></i> DB ë°±ì—…
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ë°±ì—…/ë³µì› ê¸°ëŠ¥ -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-database"></i> ë°ì´í„° ê´€ë¦¬</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_backup') }}" class="btn btn-outline-primary w-100">
              <i class="fas fa-download"></i> DB ë°±ì—…
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_restore') }}" class="btn btn-outline-warning w-100">
              <i class="fas fa-upload"></i> DB ë³µì›
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_file_backup') }}" class="btn btn-outline-info w-100">
              <i class="fas fa-folder-open"></i> íŒŒì¼ ë°±ì—…
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_file_restore') }}" class="btn btn-outline-secondary w-100">
              <i class="fas fa-folder-plus"></i> íŒŒì¼ ë³µì›
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì¶œê²° í†µê³„ ì°¨íŠ¸ ì„¹ì…˜ -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> ì¶œê²° í†µê³„ ì°¨íŠ¸</h5>
        <div class="mt-2">
          <button onclick="exportChart()" class="btn btn-sm btn-success">
            <i class="fas fa-download"></i> ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥
          </button>
          <button onclick="refreshChart()" class="btn btn-sm btn-primary">
            <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="attendanceChart" width="700" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- íŒ€ë³„ í†µê³„ ì°¨íŠ¸ -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> íŒ€ë³„ ì¶œê²° í†µê³„</h5>
      </div>
      <div class="card-body">
        <canvas id="teamChart" width="400" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-doughnut"></i> ì‚¬ìœ ë³„ í†µê³„</h5>
      </div>
      <div class="card-body">
        <canvas id="reasonChart" width="400" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">ì§ì›ìˆ˜</h5>
        <p class="card-text fs-2">{{ num_users }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">ëˆ„ì  ì¶œê·¼ê¸°ë¡</h5>
        <p class="card-text fs-2">{{ num_attendance }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    {% if warn_users %}
      <div class="alert alert-warning">
        <b>ê²½ê³ !</b> {{ warn_users|join(', ') }} : ì´ë²ˆ ë‹¬ ì§€ê° 2íšŒ ì´ìƒ/ê²°ê·¼ ë°œìƒ
      </div>
    {% endif %}
  </div>
</div>

<!-- ì›”ë³„ ë³€í™” ì¶”ì´ ì°¨íŠ¸ -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> ì›”ë³„ ë³€í™” ì¶”ì´</h5>
      </div>
      <div class="card-body">
        <canvas id="monthlyStatsChart" width="750" height="320"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ì•Œë¦¼ ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> ì•Œë¦¼ ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</h5>
      </div>
      <div class="card-body">
        <canvas id="categoryPieChart" width="400" height="250"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> í†µê³„ ìš”ì•½</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-primary">{{ noti_stats|length }}</h4>
              <small class="text-muted">ì›”ë³„ ì•Œë¦¼ í†µê³„</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-success">{{ noti_category_stats|length }}</h4>
              <small class="text-muted">ì•Œë¦¼ ì¹´í…Œê³ ë¦¬</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-info">{{ work_stats|length }}</h4>
              <small class="text-muted">ê·¼ë¬´ ìŠ¤ì¼€ì¤„ ì›”</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-warning">{{ clean_stats|length }}</h4>
              <small class="text-muted">ì²­ì†Œ ê³„íš ì›”</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì§€ì ë³„ ë¹„êµ -->
<h5>ì§€ì ë³„ ê·¼ë¬´ì‹œê°„/ì§€ê°/ê²°ê·¼ ë¹„êµ</h5>
<table class="table">
  <thead><tr><th>ì§€ì </th><th>ì§ì›ìˆ˜</th><th>ì´ ê·¼ë¬´(ë¶„)</th><th>ì§€ê°</th><th>ê²°ê·¼</th></tr></thead>
  <tbody>
    {% for r in result %}
    <tr>
      <td>{{ r.branch }}</td>
      <td>{{ r.user_count }}</td>
      <td>{{ r.total_work }}</td>
      <td>{{ r.total_late }}</td>
      <td>{{ r.total_absent }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<canvas id="branchChart"></canvas>

<div class="row">
  <div class="col-md-6">
    <h5>ì›”ë³„ ì§ì› ê·¼ë¬´ì‹œê°„ í•©ê³„</h5>
    <canvas id="barChart"></canvas>
  </div>
  <div class="col-md-6">
    <h5>ì¼ìë³„ ê·¼ë¬´ì‹œê°„(ë¶„) íŠ¸ë Œë“œ</h5>
    <canvas id="lineChart"></canvas>
  </div>
</div>
<div class="row mt-4">
  <div class="col-md-6">
    <h5>ê·¼ë¬´ì‹œê°„ ë¶„í¬</h5>
    <canvas id="pieChart"></canvas>
  </div>
  <div class="col-md-6">
    <h5>ì´ë²ˆë‹¬ ì§€ê° ë­í‚¹</h5>
    <ol>
      {% for r in top_late %}
      <li>{{ r.user }} ({{ r.late_count }}íšŒ)</li>
      {% endfor %}
    </ol>
    <h5>ì´ë²ˆë‹¬ ê²°ê·¼ ë­í‚¹</h5>
    <ol>
      {% for r in top_absent %}
      <li>{{ r.user }} ({{ r.absent_count }}íšŒ)</li>
      {% endfor %}
    </ol>
  </div>
</div>

<h5 class="mt-4">ìµœê·¼ ì¶œí‡´ê·¼ ì´ë ¥(10ê±´)</h5>
<table class="table table-bordered">
  <thead>
    <tr><th>ì§ì›</th><th>ì¶œê·¼</th><th>í‡´ê·¼</th><th>ê·¼ë¬´(ë¶„)</th><th>ìƒíƒœ</th></tr>
  </thead>
  <tbody>
    {% for r in recent %}
    <tr>
      <td>{{ r.user }}</td>
      <td>{{ r.clock_in }}</td>
      <td>{{ r.clock_out if r.clock_out else 'ë¯¸ì…ë ¥' }}</td>
      <td>{{ r.work_minutes }}</td>
      <td>{{ r.status }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<p>ì§ì› í‰ê·  ì£¼ë¬¸ ì²˜ë¦¬ ì‹œê°„: {{ avg_processing|round(1) }}ë¶„</p>
<p>ê¸°ì¤€ ì´ˆê³¼ ì£¼ë¬¸ ê±´ìˆ˜: {{ exceed_count }}ê±´</p>

<!-- ë§¤ì¥ë³„ ì£¼ë¬¸/í”¼ë“œë°± ìš”ì•½ í‘œ -->
<div class="card p-4 mb-4">
  <h4 class="mb-3">ë§¤ì¥ë³„ ì£¼ë¬¸/í”¼ë“œë°± ìš”ì•½</h4>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>ë§¤ì¥ëª…</th>
        <th>ì£¼ë¬¸ ìˆ˜</th>
        <th>í”¼ë“œë°± ìˆ˜</th>
      </tr>
    </thead>
    <tbody>
      {% for stat in branch_stats %}
      <tr>
        <td>{{ stat.branch.name }}</td>
        <td>{{ stat.orders }}</td>
        <td>{{ stat.feedbacks }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ìµœê·¼ ì£¼ë¬¸ 5ê°œ -->
<div class="card p-4 mb-4">
  <h4 class="mb-3">ìµœê·¼ ì£¼ë¬¸</h4>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>ì£¼ë¬¸ID</th>
        <th>ë‹´ë‹¹ì§ì›</th>
        <th>ë§¤ì¥</th>
        <th>ìƒì„±ì‹œê°</th>
      </tr>
    </thead>
    <tbody>
      {% for order in recent_orders %}
      <tr>
        <td>{{ order.id }}</td>
        <td>{{ order.employee.username if order.employee else '-' }}</td>
        <td>{{ order.branch.name if order.branch else '-' }}</td>
        <td>{{ order.created_at }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ìµœê·¼ ì•Œë¦¼ 5ê°œ -->
<div class="card p-4 mb-4">
  <h4 class="mb-3">ìµœê·¼ ì•Œë¦¼</h4>
  <ul>
    {% for n in recent_notifications %}
      <li>{{ n.title }} - {{ n.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
    {% endfor %}
  </ul>
</div>

<!-- ìµœê·¼ í”¼ë“œë°±/ë¬¸ì˜ 5ê°œ -->
<div class="card p-4 mb-4">
  <h4 class="mb-3">ìµœê·¼ ê°œì„ Â·ë¬¸ì˜ì‚¬í•­</h4>
  <ul>
    {% for f in recent_feedbacks %}
      <li>{{ f.title }} ({{ f.status }}) - {{ f.created_at.strftime('%Y-%m-%d') }}</li>
    {% endfor %}
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ì›”ë³„ ë³€í™” ì¶”ì´ ì°¨íŠ¸
let monthlyLabels = {{ noti_stats|map(attribute='month')|list|tojson }};
let notiData = {{ noti_stats|map(attribute='count')|list|tojson }};
let workData = {{ work_stats|map(attribute='count')|list|tojson }};
let orderData = {{ order_stats|map(attribute='count')|list|tojson }};
let cleanData = {{ clean_stats|map(attribute='count')|list|tojson }};

let categories = {{ noti_category_stats|map(attribute='category')|list|tojson }};
let categoryCounts = {{ noti_category_stats|map(attribute='count')|list|tojson }};

let monthlyCtx = document.getElementById('monthlyStatsChart').getContext('2d');
let monthlyChart = new Chart(monthlyCtx, {
  type: 'line',
  data: {
    labels: monthlyLabels,
    datasets: [
      { 
        label: 'ì•Œë¦¼', 
        data: notiData, 
        borderColor: '#f0ad4e', 
        backgroundColor: 'rgba(240, 173, 78, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: 'ê·¼ë¬´', 
        data: workData, 
        borderColor: '#5bc0de', 
        backgroundColor: 'rgba(91, 192, 222, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: 'ë°œì£¼', 
        data: orderData, 
        borderColor: '#5cb85c', 
        backgroundColor: 'rgba(92, 184, 92, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: 'ì²­ì†Œ', 
        data: cleanData, 
        borderColor: '#d9534f', 
        backgroundColor: 'rgba(217, 83, 79, 0.1)',
        fill: false,
        tension: 0.4
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { 
      legend: { position: 'top' },
      title: {
        display: true,
        text: 'ì›”ë³„ ì—…ë¬´ í˜„í™© ë³€í™”'
      }
    },
    scales: { 
      y: { 
        beginAtZero: true,
        title: {
          display: true,
          text: 'ê±´ìˆ˜'
        }
      },
      x: {
        title: {
          display: true,
          text: 'ì›”'
        }
      }
    }
  }
});

// ì•Œë¦¼ ì¹´í…Œê³ ë¦¬ë³„ íŒŒì´ ì°¨íŠ¸
let pieCtx = document.getElementById('categoryPieChart').getContext('2d');
let pieChart = new Chart(pieCtx, {
  type: 'pie',
  data: {
    labels: categories,
    datasets: [{ 
      data: categoryCounts,
      backgroundColor: [
        '#f0ad4e',
        '#5bc0de', 
        '#5cb85c',
        '#d9534f',
        '#337ab7',
        '#777777'
      ]
    }]
  },
  options: {
    responsive: true,
    plugins: { 
      legend: { position: 'bottom' },
      title: {
        display: true,
        text: 'ì•Œë¦¼ ì¹´í…Œê³ ë¦¬ ë¶„í¬'
      }
    }
  }
});

// ê¸°ì¡´ ì°¨íŠ¸ë“¤
// ì§€ì ë³„ ì°¨íŠ¸
new Chart(document.getElementById('branchChart'), {
  type: 'bar',
  data: {
    labels: {{ branch_names|tojson }},
    datasets: [{
      label: 'ì§€ì ë³„ ê·¼ë¬´ì‹œê°„(ë¶„)',
      data: {{ result|map(attribute='total_work')|list|tojson }},
      backgroundColor: 'rgba(54, 162, 235, 0.5)'
    }]
  }
});

new Chart(document.getElementById('barChart'), {
  type: 'bar',
  data: {
    labels: {{ chart_labels|tojson }},
    datasets: [{ label: 'ê·¼ë¬´ì‹œê°„(ë¶„)', data: {{ chart_data|tojson }}, borderWidth: 1 }]
  }, options: {scales: { y: { beginAtZero: true } } }
});
new Chart(document.getElementById('lineChart'), {
  type: 'line',
  data: {
    labels: {{ trend_dates|tojson }},
    datasets: [{ label: 'ê·¼ë¬´ì‹œê°„(ë¶„)', data: {{ trend_data|tojson }}, borderWidth: 1, tension: 0.4 }]
  }
});
new Chart(document.getElementById('pieChart'), {
  type: 'pie',
  data: {
    labels: {{ dist_labels|tojson }},
    datasets: [{ data: {{ dist_data|tojson }} }]
  }
});

// ì¶œê²° í†µê³„ ì°¨íŠ¸
let attendanceChart = null;

function loadAttendanceChart() {
  // ì„ì‹œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
  const mockData = {
    labels: ['01-01', '01-02', '01-03', '01-04', '01-05', '01-06', '01-07'],
    late: [2, 1, 3, 0, 1, 2, 1],
    absent: [0, 1, 0, 1, 0, 0, 1],
    total: [15, 14, 15, 14, 15, 15, 14]
  };
  
  if (attendanceChart) attendanceChart.destroy();
  
  const ctx = document.getElementById('attendanceChart');
  if (ctx) {
    attendanceChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: mockData.labels,
        datasets: [
          {label: 'ì§€ê°', data: mockData.late, backgroundColor: '#ffe082'},
          {label: 'ê²°ê·¼', data: mockData.absent, backgroundColor: '#ef9a9a'},
          {label: 'ì „ì²´', data: mockData.total, backgroundColor: '#90caf9', type: 'line', order: 0}
        ]
      },
      options: {responsive: true, scales: {y: {beginAtZero: true}}}
    });
  }
}

function exportChart() {
  if (attendanceChart) {
    const url = attendanceChart.toBase64Image();
    const a = document.createElement('a');
    a.href = url; a.download = 'attendance_chart.png'; a.click();
  }
}

function refreshChart() {
  loadAttendanceChart();
}

// íŒ€ë³„ ì°¨íŠ¸
function loadTeamChart() {
  const mockTeamData = {
    labels: ['íŒ€A', 'íŒ€B', 'íŒ€C', 'ë¯¸ì§€ì •'],
    total: [25, 30, 20, 5]
  };
  
  const ctx = document.getElementById('teamChart');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'pie',
      data: {
        labels: mockTeamData.labels,
        datasets: [{
          data: mockTeamData.total,
          backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: 'íŒ€ë³„ ì¶œê²° í˜„í™©'},
          legend: {position: 'bottom'}
        }
      }
    });
  }
}

// ì‚¬ìœ ë³„ ì°¨íŠ¸
function loadReasonChart() {
  const mockReasonData = {
    labels: ['ì •ìƒì¶œê·¼', 'ì§€ê°', 'ê²°ê·¼', 'ë³‘ê°€', 'ê¸°íƒ€'],
    data: [120, 15, 8, 5, 12]
  };
  
  const ctx = document.getElementById('reasonChart');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: mockReasonData.labels,
        datasets: [{
          data: mockReasonData.data,
          backgroundColor: ['#4bc0c0', '#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: 'ì‚¬ìœ ë³„ ì¶œê²° ë¶„í¬'},
          legend: {position: 'bottom'}
        }
      }
    });
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì°¨íŠ¸ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  loadAttendanceChart();
  loadTeamChart();
  loadReasonChart();
});

// í•„í„° í¼ ì œì¶œ ì‹œ ì°¨íŠ¸ ìƒˆë¡œê³ ì¹¨
document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', function() {
    setTimeout(() => {
      refreshChart();
    }, 100);
  });
});
</script>
{% endblock %} 