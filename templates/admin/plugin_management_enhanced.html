<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플러그인 관리 - Your Program</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div class="min-h-screen">
        <!-- 헤더 -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="fas fa-cogs mr-3 text-blue-600"></i>
                            플러그인 관리
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="refreshBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>
                            새로고침
                        </button>
                        <button id="bulkActionBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-tasks mr-2"></i>
                            일괄 작업
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 통계 카드 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                            <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">활성 플러그인</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="activePlugins">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 dark:bg-red-900">
                            <i class="fas fa-pause-circle text-red-600 dark:text-red-400 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">비활성 플러그인</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="inactivePlugins">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                            <i class="fas fa-chart-line text-blue-600 dark:text-blue-400 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">평균 성능</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="avgPerformance">0%</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900">
                            <i class="fas fa-exclamation-triangle text-purple-600 dark:text-purple-400 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">오류 발생</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="errorPlugins">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 성능 차트 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">CPU 사용률</h3>
                    <canvas id="cpuChart" width="400" height="200"></canvas>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">메모리 사용률</h3>
                    <canvas id="memoryChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- 검색 및 필터 -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">검색</label>
                        <input type="text" id="searchInput" placeholder="플러그인 이름, 설명..." 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">상태</label>
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">모든 상태</option>
                            <option value="active">활성</option>
                            <option value="inactive">비활성</option>
                            <option value="error">오류</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">카테고리</label>
                        <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">모든 카테고리</option>
                            <option value="utility">유틸리티</option>
                            <option value="api">API</option>
                            <option value="ui">UI</option>
                            <option value="ai">AI</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">정렬</label>
                        <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="name">이름순</option>
                            <option value="performance">성능순</option>
                            <option value="last_updated">최신순</option>
                            <option value="size">크기순</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 플러그인 테이블 -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">설치된 플러그인</h3>
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">전체 선택</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    플러그인
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    상태
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    성능
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    크기
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    업데이트
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    작업
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="pluginsTableBody">
                            <!-- 플러그인 행들이 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- 플러그인 상세 모달 -->
    <div id="pluginDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="pluginDetailTitle">플러그인 상세</h3>
                    <button id="closePluginDetailModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6" id="pluginDetailContent">
                    <!-- 플러그인 상세 내용이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 설정 모달 -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
                <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">플러그인 설정</h3>
                    <button id="closeSettingsModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6" id="settingsContent">
                    <!-- 설정 내용이 여기에 동적으로 추가됩니다 -->
                </div>
                
                <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
                    <button id="cancelSettings" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                        취소
                    </button>
                    <button id="saveSettings" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                        저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 일괄 작업 모달 -->
    <div id="bulkActionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">일괄 작업</h3>
                    <button id="closeBulkActionModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">작업 선택</label>
                            <select id="bulkAction" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md">
                                <option value="">작업을 선택하세요</option>
                                <option value="activate">활성화</option>
                                <option value="deactivate">비활성화</option>
                                <option value="update">업데이트</option>
                                <option value="delete">삭제</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">선택된 플러그인</label>
                            <div id="selectedPlugins" class="text-sm text-gray-600 dark:text-gray-400">
                                <!-- 선택된 플러그인 목록이 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
                    <button id="cancelBulkAction" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                        취소
                    </button>
                    <button id="executeBulkAction" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700">
                        실행
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let plugins = [];
        let filteredPlugins = [];
        let selectedPlugins = new Set();
        let cpuChart = null;
        let memoryChart = null;

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadPlugins();
            setupEventListeners();
            initializeCharts();
            startPerformanceMonitoring();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 검색 및 필터
            document.getElementById('searchInput').addEventListener('input', filterPlugins);
            document.getElementById('statusFilter').addEventListener('change', filterPlugins);
            document.getElementById('categoryFilter').addEventListener('change', filterPlugins);
            document.getElementById('sortFilter').addEventListener('change', filterPlugins);

            // 새로고침
            document.getElementById('refreshBtn').addEventListener('click', loadPlugins);

            // 일괄 작업
            document.getElementById('bulkActionBtn').addEventListener('click', showBulkActionModal);
            document.getElementById('closeBulkActionModal').addEventListener('click', hideBulkActionModal);
            document.getElementById('cancelBulkAction').addEventListener('click', hideBulkActionModal);
            document.getElementById('executeBulkAction').addEventListener('click', executeBulkAction);

            // 전체 선택
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

            // 모달 닫기
            document.getElementById('closePluginDetailModal').addEventListener('click', hidePluginDetailModal);
            document.getElementById('closeSettingsModal').addEventListener('click', hideSettingsModal);
        }

        // 플러그인 로드
        async function loadPlugins() {
            try {
                const response = await fetch('/api/modules/installed');
                const data = await response.json();
                
                plugins = data.modules || [];
                filteredPlugins = [...plugins];
                
                updateStatistics();
                renderPluginsTable();
                
            } catch (error) {
                console.error('플러그인 로드 실패:', error);
                showNotification('플러그인 로드를 실패했습니다.', 'error');
            }
        }

        // 통계 업데이트
        function updateStatistics() {
            const activeCount = plugins.filter(p => p.status === 'active').length;
            const inactiveCount = plugins.filter(p => p.status === 'inactive').length;
            const errorCount = plugins.filter(p => p.status === 'error').length;
            
            // 평균 성능 계산
            const activePlugins = plugins.filter(p => p.status === 'active');
            const avgPerformance = activePlugins.length > 0 
                ? activePlugins.reduce((sum, p) => sum + (p.performance?.response_time || 0), 0) / activePlugins.length
                : 0;
            
            document.getElementById('activePlugins').textContent = activeCount;
            document.getElementById('inactivePlugins').textContent = inactiveCount;
            document.getElementById('errorPlugins').textContent = errorCount;
            document.getElementById('avgPerformance').textContent = `${Math.round(avgPerformance)}ms`;
        }

        // 차트 초기화
        function initializeCharts() {
            // CPU 차트
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU 사용률 (%)',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // 메모리 차트
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '메모리 사용률 (%)',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // 성능 모니터링 시작
        function startPerformanceMonitoring() {
            setInterval(async () => {
                try {
                    const response = await fetch('/api/modules/performance');
                    const data = await response.json();
                    
                    updatePerformanceCharts(data);
                } catch (error) {
                    console.error('성능 데이터 로드 실패:', error);
                }
            }, 30000); // 30초마다 업데이트
        }

        // 성능 차트 업데이트
        function updatePerformanceCharts(data) {
            const now = new Date().toLocaleTimeString();
            
            // CPU 차트 업데이트
            const avgCpu = data.modules.reduce((sum, m) => sum + m.cpu_usage, 0) / data.modules.length;
            cpuChart.data.labels.push(now);
            cpuChart.data.datasets[0].data.push(avgCpu);
            
            if (cpuChart.data.labels.length > 10) {
                cpuChart.data.labels.shift();
                cpuChart.data.datasets[0].data.shift();
            }
            cpuChart.update();

            // 메모리 차트 업데이트
            const avgMemory = data.modules.reduce((sum, m) => sum + m.memory_usage, 0) / data.modules.length;
            memoryChart.data.labels.push(now);
            memoryChart.data.datasets[0].data.push(avgMemory);
            
            if (memoryChart.data.labels.length > 10) {
                memoryChart.data.labels.shift();
                memoryChart.data.datasets[0].data.shift();
            }
            memoryChart.update();
        }

        // 플러그인 테이블 렌더링
        function renderPluginsTable() {
            const tbody = document.getElementById('pluginsTableBody');
            tbody.innerHTML = '';

            filteredPlugins.forEach(plugin => {
                const row = createPluginRow(plugin);
                tbody.appendChild(row);
            });
        }

        // 플러그인 행 생성
        function createPluginRow(plugin) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
            
            const statusClass = getStatusClass(plugin.status);
            const statusText = getStatusText(plugin.status);
            const performanceColor = getPerformanceColor(plugin.performance?.response_time || 0);

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <input type="checkbox" class="plugin-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                               data-plugin-id="${plugin.plugin_id}" ${selectedPlugins.has(plugin.plugin_id) ? 'checked' : ''}>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${plugin.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${plugin.description}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900 dark:text-white">
                        <span class="font-medium ${performanceColor}">${plugin.performance?.response_time || 0}ms</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        CPU: ${plugin.performance?.cpu_usage || 0}% | RAM: ${plugin.performance?.memory_usage || 0}%
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                    ${plugin.size || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${new Date(plugin.last_updated).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="viewPluginDetail('${plugin.plugin_id}')" 
                                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="openPluginSettings('${plugin.plugin_id}')" 
                                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                            <i class="fas fa-cog"></i>
                        </button>
                        ${plugin.status === 'active' ? `
                            <button onclick="deactivatePlugin('${plugin.plugin_id}')" 
                                    class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300">
                                <i class="fas fa-pause"></i>
                            </button>
                        ` : `
                            <button onclick="activatePlugin('${plugin.plugin_id}')" 
                                    class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                <i class="fas fa-play"></i>
                            </button>
                        `}
                        <button onclick="deletePlugin('${plugin.plugin_id}')" 
                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            // 체크박스 이벤트 리스너
            const checkbox = row.querySelector('.plugin-checkbox');
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedPlugins.add(plugin.plugin_id);
                } else {
                    selectedPlugins.delete(plugin.plugin_id);
                }
                updateSelectAllState();
            });

            return row;
        }

        // 상태 클래스 반환
        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                case 'inactive': return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                case 'error': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
            }
        }

        // 상태 텍스트 반환
        function getStatusText(status) {
            switch (status) {
                case 'active': return '활성';
                case 'inactive': return '비활성';
                case 'error': return '오류';
                default: return '알 수 없음';
            }
        }

        // 성능 색상 반환
        function getPerformanceColor(responseTime) {
            if (responseTime < 100) return 'text-green-600';
            if (responseTime < 300) return 'text-yellow-600';
            return 'text-red-600';
        }

        // 플러그인 필터링
        function filterPlugins() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            filteredPlugins = plugins.filter(plugin => {
                const matchesSearch = !searchTerm || 
                    plugin.name.toLowerCase().includes(searchTerm) ||
                    plugin.description.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !status || plugin.status === status;
                const matchesCategory = !category || plugin.category === category;

                return matchesSearch && matchesStatus && matchesCategory;
            });

            // 정렬
            sortPlugins(sortBy);

            renderPluginsTable();
        }

        // 플러그인 정렬
        function sortPlugins(sortBy) {
            switch (sortBy) {
                case 'name':
                    filteredPlugins.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'performance':
                    filteredPlugins.sort((a, b) => (a.performance?.response_time || 0) - (b.performance?.response_time || 0));
                    break;
                case 'last_updated':
                    filteredPlugins.sort((a, b) => new Date(b.last_updated) - new Date(a.last_updated));
                    break;
                case 'size':
                    filteredPlugins.sort((a, b) => {
                        const sizeA = parseFloat(a.size) || 0;
                        const sizeB = parseFloat(b.size) || 0;
                        return sizeA - sizeB;
                    });
                    break;
            }
        }

        // 전체 선택 토글
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.plugin-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedPlugins.add(checkbox.dataset.pluginId);
                } else {
                    selectedPlugins.delete(checkbox.dataset.pluginId);
                }
            });
        }

        // 전체 선택 상태 업데이트
        function updateSelectAllState() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.plugin-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // 일괄 작업 모달 표시
        function showBulkActionModal() {
            if (selectedPlugins.size === 0) {
                showNotification('선택된 플러그인이 없습니다.', 'warning');
                return;
            }

            document.getElementById('selectedPlugins').innerHTML = Array.from(selectedPlugins)
                .map(id => {
                    const plugin = plugins.find(p => p.plugin_id === id);
                    return `<div class="text-sm">• ${plugin?.name || id}</div>`;
                }).join('');

            document.getElementById('bulkActionModal').classList.remove('hidden');
        }

        // 일괄 작업 모달 숨김
        function hideBulkActionModal() {
            document.getElementById('bulkActionModal').classList.add('hidden');
            document.getElementById('bulkAction').value = '';
        }

        // 일괄 작업 실행
        async function executeBulkAction() {
            const action = document.getElementById('bulkAction').value;
            if (!action) {
                showNotification('작업을 선택해주세요.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/modules/bulk-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        plugin_ids: Array.from(selectedPlugins)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`${action} 작업이 완료되었습니다.`, 'success');
                    selectedPlugins.clear();
                    loadPlugins();
                    hideBulkActionModal();
                } else {
                    showNotification(data.error || '작업에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('일괄 작업 실패:', error);
                showNotification('작업에 실패했습니다.', 'error');
            }
        }

        // 플러그인 활성화
        async function activatePlugin(pluginId) {
            try {
                const response = await fetch(`/api/modules/${pluginId}/activate`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('플러그인이 활성화되었습니다.', 'success');
                    loadPlugins();
                } else {
                    showNotification(data.error || '활성화에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('플러그인 활성화 실패:', error);
                showNotification('활성화에 실패했습니다.', 'error');
            }
        }

        // 플러그인 비활성화
        async function deactivatePlugin(pluginId) {
            if (!confirm('플러그인을 비활성화하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/modules/${pluginId}/deactivate`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('플러그인이 비활성화되었습니다.', 'success');
                    loadPlugins();
                } else {
                    showNotification(data.error || '비활성화에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('플러그인 비활성화 실패:', error);
                showNotification('비활성화에 실패했습니다.', 'error');
            }
        }

        // 플러그인 삭제
        async function deletePlugin(pluginId) {
            if (!confirm('플러그인을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                const response = await fetch(`/api/modules/${pluginId}/delete`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('플러그인이 삭제되었습니다.', 'success');
                    loadPlugins();
                } else {
                    showNotification(data.error || '삭제에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('플러그인 삭제 실패:', error);
                showNotification('삭제에 실패했습니다.', 'error');
            }
        }

        // 플러그인 상세 보기
        async function viewPluginDetail(pluginId) {
            try {
                const response = await fetch(`/api/modules/${pluginId}`);
                const plugin = await response.json();

                document.getElementById('pluginDetailTitle').textContent = plugin.name;
                document.getElementById('pluginDetailContent').innerHTML = createPluginDetailContent(plugin);
                document.getElementById('pluginDetailModal').classList.remove('hidden');
            } catch (error) {
                console.error('플러그인 상세 로드 실패:', error);
                showNotification('플러그인 상세 정보를 불러올 수 없습니다.', 'error');
            }
        }

        // 플러그인 상세 내용 생성
        function createPluginDetailContent(plugin) {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">기본 정보</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">이름</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.name}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">버전</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.version}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">상태</dt>
                                    <dd class="text-sm">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(plugin.status)}">
                                            ${getStatusText(plugin.status)}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">설치일</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${new Date(plugin.installed_at).toLocaleDateString()}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">성능 정보</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">응답 시간</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.performance?.response_time || 0}ms</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">CPU 사용률</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.performance?.cpu_usage || 0}%</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">메모리 사용률</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.performance?.memory_usage || 0}%</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">크기</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white">${plugin.size || 'N/A'}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">설명</h4>
                        <p class="text-gray-600 dark:text-gray-300">${plugin.description}</p>
                    </div>
                    
                    ${plugin.dependencies && plugin.dependencies.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">의존성</h4>
                            <div class="flex flex-wrap gap-2">
                                ${plugin.dependencies.map(dep => `
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        ${dep}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="hidePluginDetailModal()" 
                                class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md">
                            닫기
                        </button>
                    </div>
                </div>
            `;
        }

        // 플러그인 상세 모달 숨김
        function hidePluginDetailModal() {
            document.getElementById('pluginDetailModal').classList.add('hidden');
        }

        // 플러그인 설정 열기
        async function openPluginSettings(pluginId) {
            try {
                const response = await fetch(`/api/modules/${pluginId}/settings`);
                const settings = await response.json();

                document.getElementById('settingsContent').innerHTML = createSettingsContent(pluginId, settings);
                document.getElementById('settingsModal').classList.remove('hidden');
            } catch (error) {
                console.error('설정 로드 실패:', error);
                showNotification('설정을 불러올 수 없습니다.', 'error');
            }
        }

        // 설정 내용 생성
        function createSettingsContent(pluginId, settings) {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">플러그인 설정</h4>
                    <div id="settingsForm">
                        <!-- 설정 폼이 여기에 동적으로 추가됩니다 -->
                        <p class="text-gray-500 dark:text-gray-400">설정 옵션이 없습니다.</p>
                    </div>
                </div>
            `;
        }

        // 설정 모달 숨김
        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // 알림 표시
        function showNotification(message, type = 'info') {
            // 간단한 알림 구현
            alert(message);
        }
    </script>
</body>
</html> 