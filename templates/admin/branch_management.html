{% extends 'base_modern.html' %}
{% block title %}ë§¤ì¥ ê´€ë¦¬{% endblock %}
{% block content %}
<!-- í—¤ë” -->
<div class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl p-6 mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold">ğŸª ë§¤ì¥ ê´€ë¦¬</h1>
      <p class="text-green-100 mt-2">ë§¤ì¥ ì •ë³´ ë° ìš´ì˜ ì„¤ì • ê´€ë¦¬</p>
    </div>
    <button onclick="openAddBranchModal()" class="bg-white text-green-600 px-6 py-3 rounded-lg font-semibold hover:bg-green-50 transition-colors">
      + ìƒˆ ë§¤ì¥ ì¶”ê°€
    </button>
  </div>
</div>

<!-- í†µê³„ ì¹´ë“œ -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì´ ë§¤ì¥</p>
        <p class="text-2xl font-bold text-green-600">{{ total_branches }}</p>
      </div>
      <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
        <span class="text-2xl">ğŸª</span>
      </div>
    </div>
  </div>
  
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ìš´ì˜ ì¤‘</p>
        <p class="text-2xl font-bold text-blue-600">{{ active_branches }}</p>
      </div>
      <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
        <span class="text-2xl">âœ…</span>
      </div>
    </div>
  </div>
  
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì´ ë§¤ì¶œ</p>
        <p class="text-2xl font-bold text-purple-600">{{ total_sales | int | comma }}ì›</p>
      </div>
      <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
        <span class="text-2xl">ğŸ’°</span>
      </div>
    </div>
  </div>
  
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">í‰ê·  ë§¤ì¶œ</p>
        <p class="text-2xl font-bold text-yellow-600">{{ avg_sales | int | comma }}ì›</p>
      </div>
      <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
        <span class="text-2xl">ğŸ“Š</span>
      </div>
    </div>
  </div>
</div>

<!-- ê²€ìƒ‰ ë° í•„í„° -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
  <div class="flex flex-col md:flex-row gap-4">
    <div class="flex-1">
      <input type="text" id="searchInput" placeholder="ë§¤ì¥ëª…, ì£¼ì†Œ, ë§¤ë‹ˆì €ë¡œ ê²€ìƒ‰..." 
             class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
    </div>
    <div class="flex gap-2">
      <select id="statusFilter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        <option value="">ëª¨ë“  ìƒíƒœ</option>
        <option value="active">ìš´ì˜ ì¤‘</option>
        <option value="inactive">ìš´ì˜ ì¤‘ë‹¨</option>
        <option value="maintenance">ì ê²€ ì¤‘</option>
      </select>
      <select id="regionFilter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        <option value="">ëª¨ë“  ì§€ì—­</option>
        <option value="seoul">ì„œìš¸</option>
        <option value="busan">ë¶€ì‚°</option>
        <option value="daegu">ëŒ€êµ¬</option>
        <option value="incheon">ì¸ì²œ</option>
        <option value="gwangju">ê´‘ì£¼</option>
        <option value="daejeon">ëŒ€ì „</option>
        <option value="ulsan">ìš¸ì‚°</option>
        <option value="sejong">ì„¸ì¢…</option>
      </select>
    </div>
  </div>
</div>

<!-- ë§¤ì¥ ëª©ë¡ ê·¸ë¦¬ë“œ -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for branch in branches %}
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
    <div class="p-6">
      <!-- ë§¤ì¥ í—¤ë” -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
            <span class="text-xl font-semibold text-green-600">{{ branch.name[0] if branch.name else 'M' }}</span>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ branch.name }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">{{ branch.address if branch.address else 'ì£¼ì†Œ ì—†ìŒ' }}</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="editBranch({{ branch.id }})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
            <span class="text-lg">âœï¸</span>
          </button>
          <button onclick="deleteBranch({{ branch.id }})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
            <span class="text-lg">ğŸ—‘ï¸</span>
          </button>
        </div>
      </div>
      
      <!-- ë§¤ì¥ ì •ë³´ -->
      <div class="space-y-3 mb-4">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600 dark:text-gray-400">ìƒíƒœ:</span>
          <span class="font-semibold 
            {% if branch.status == 'active' %}text-green-600
            {% elif branch.status == 'inactive' %}text-red-600
            {% else %}text-yellow-600{% endif %}">
            {% if branch.status == 'active' %}ìš´ì˜ ì¤‘
            {% elif branch.status == 'inactive' %}ìš´ì˜ ì¤‘ë‹¨
            {% else %}ì ê²€ ì¤‘{% endif %}
          </span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600 dark:text-gray-400">ë§¤ë‹ˆì €:</span>
          <span class="font-semibold text-gray-900 dark:text-white">{{ branch.manager_name if branch.manager_name else 'ë¯¸ì§€ì •' }}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600 dark:text-gray-400">ì§ì› ìˆ˜:</span>
          <span class="font-semibold text-gray-900 dark:text-white">{{ branch.staff_count }}ëª…</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600 dark:text-gray-400">ì›” ë§¤ì¶œ:</span>
          <span class="font-semibold text-gray-900 dark:text-white">{{ branch.sales | int | comma }}ì›</span>
        </div>
      </div>
      
      <!-- ì•¡ì…˜ ë²„íŠ¼ -->
      <div class="flex space-x-2">
        <button onclick="viewBranchDetail({{ branch.id }})" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
          ìƒì„¸ë³´ê¸°
        </button>
        <button onclick="viewBranchStats({{ branch.id }})" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
          í†µê³„
        </button>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-span-full">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
      <div class="flex flex-col items-center">
        <span class="text-6xl mb-4">ğŸª</span>
        <p class="text-xl font-medium text-gray-900 dark:text-white mb-2">ë“±ë¡ëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤</p>
        <p class="text-gray-500 dark:text-gray-400 mb-6">ìƒˆ ë§¤ì¥ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
        <button onclick="openAddBranchModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
          + ì²« ë§¤ì¥ ì¶”ê°€
        </button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- ìƒˆ ë§¤ì¥ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addBranchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full">
      <div class="p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ìƒˆ ë§¤ì¥ ì¶”ê°€</h3>
        <form id="addBranchForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ë§¤ì¥ëª…</label>
              <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì£¼ì†Œ</label>
              <input type="text" name="address" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì „í™”ë²ˆí˜¸</label>
              <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ë§¤ë‹ˆì €</label>
              <select name="manager_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                <option value="">ë§¤ë‹ˆì € ì„ íƒ</option>
                {% for manager in managers %}
                <option value="{{ manager.id }}">{{ manager.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ìƒíƒœ</label>
              <select name="status" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                <option value="active">ìš´ì˜ ì¤‘</option>
                <option value="inactive">ìš´ì˜ ì¤‘ë‹¨</option>
                <option value="maintenance">ì ê²€ ì¤‘</option>
              </select>
            </div>
          </div>
          <div class="flex space-x-3 mt-6">
            <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
              ì¶”ê°€
            </button>
            <button type="button" onclick="closeAddBranchModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500">
              ì·¨ì†Œ
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// ê²€ìƒ‰ ë° í•„í„° ê¸°ëŠ¥
document.getElementById('searchInput').addEventListener('input', filterBranches);
document.getElementById('statusFilter').addEventListener('change', filterBranches);
document.getElementById('regionFilter').addEventListener('change', filterBranches);

function filterBranches() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const regionFilter = document.getElementById('regionFilter').value;
  
  const cards = document.querySelectorAll('.grid > div');
  
  cards.forEach(card => {
    const name = card.querySelector('h3').textContent.toLowerCase();
    const address = card.querySelector('p').textContent.toLowerCase();
    const status = card.querySelector('.text-green-600, .text-red-600, .text-yellow-600').textContent;
    
    const matchesSearch = name.includes(searchTerm) || address.includes(searchTerm);
    const matchesStatus = !statusFilter || status.includes(statusFilter);
    const matchesRegion = !regionFilter || address.includes(regionFilter);
    
    card.style.display = matchesSearch && matchesStatus && matchesRegion ? '' : 'none';
  });
}

// ëª¨ë‹¬ ê¸°ëŠ¥
function openAddBranchModal() {
  document.getElementById('addBranchModal').classList.remove('hidden');
}

function closeAddBranchModal() {
  document.getElementById('addBranchModal').classList.add('hidden');
}

// ë§¤ì¥ ê´€ë¦¬ ê¸°ëŠ¥
function editBranch(branchId) {
  window.location.href = `/admin/branch-management/edit/${branchId}`;
}

function deleteBranch(branchId) {
  if (confirm('ì •ë§ë¡œ ì´ ë§¤ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
    fetch(`/api/admin/delete-branch/${branchId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }
}

function viewBranchDetail(branchId) {
  window.location.href = `/admin/branch-management/detail/${branchId}`;
}

function viewBranchStats(branchId) {
  window.location.href = `/admin/branch-management/stats/${branchId}`;
}

// ìƒˆ ë§¤ì¥ ì¶”ê°€ í¼ ì œì¶œ
document.getElementById('addBranchForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  fetch('/api/admin/add-branch', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeAddBranchModal();
      location.reload();
    } else {
      alert('ë§¤ì¥ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸª ë§¤ì¥ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œë¨');
});
</script>
{% endblock %} 